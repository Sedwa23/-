<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Pizza Studio â€” Mobile</title>
<style>
  :root{
    --bg:#0f1222;
    --panel:rgba(255,255,255,0.10);
    --glass:rgba(255,255,255,0.08);
    --text:#eaf0ff;
    --muted:#a9b0c7;
    --accent:#48d1ff;
    --ok:#39e58c;
    --warn:#ffc857;
    --bad:#ff6b6b;
    --card:rgba(255,255,255,0.12);
    --shadow:0 8px 30px rgba(0,0,0,0.35);
    --radius:16px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;background:#0b0e1b;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* --- Mobile-first layout --- */
  body{display:flex;flex-direction:column;min-height:100svh; /* svh handles mobile chrome */}

  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;padding-top:calc(8px + env(safe-area-inset-top));background:linear-gradient(180deg,rgba(255,255,255,0.08),rgba(255,255,255,0.04));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.14)}
  header .stat{display:flex;gap:8px;align-items:center}
  .pill{background:rgba(255,255,255,0.09);padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px}
  .btn{border:none;border-radius:12px;padding:8px 12px;color:#091018;font-weight:700;background:linear-gradient(180deg,#8be9ff,var(--accent));box-shadow:inset 0 -2px 0 rgba(0,0,0,0.2),0 6px 18px rgba(72,209,255,0.25)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:linear-gradient(180deg,#c0c7dc,#96a0bd);color:#0b1022}
  .btn.warn{background:linear-gradient(180deg,#ffd57a,#ffb14a)}

  /* Main area: canvas fills available vertical space between header and bottom bar */
  .stage{position:relative;flex:1;min-height:0;display:flex;align-items:center;justify-content:center;padding:10px}
  .canvasWrap{position:relative;width:100%;max-width:720px;/* keep nice on tablets */}
  #pizza{display:block;width:100%;height:auto;aspect-ratio:1/1;border-radius:var(--radius);background:radial-gradient(1200px 600px at 70% -20%, #1a1f46 0%, #0f1222 55%, #0a0c18 100%)}
  .hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.35);padding:6px 10px;border-radius:999px;font-size:11px}
  .selectBar{position:absolute;bottom:8px;right:8px;display:flex;gap:6px;padding:6px;background:rgba(0,0,0,0.35);border-radius:12px;opacity:0;pointer-events:none;transition:opacity .12s}
  .selectBar.show{opacity:1;pointer-events:auto}
  .sbtn{border:none;padding:8px 10px;border-radius:10px;font-weight:700}
  .sbtn:nth-child(1),.sbtn:nth-child(2){background:#d9e1ff}
  .sbtn:nth-child(3),.sbtn:nth-child(4){background:#ffe0b3}
  .sbtn:nth-child(5){background:#ffd6d6}

  /* Bottom toolbar */
  .toolbar{position:sticky;bottom:0;z-index:10;display:flex;flex-direction:column;gap:8px;padding:10px 12px;padding-bottom:calc(10px + env(safe-area-inset-bottom));background:linear-gradient(0deg,rgba(255,255,255,0.08),rgba(255,255,255,0.04));backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,0.14)}
  .reqRow{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .goals{display:flex;gap:6px;overflow:auto;padding-bottom:2px}
  .goal{white-space:nowrap;background:rgba(255,255,255,0.1);padding:6px 10px;border-radius:999px;font-size:12px}
  .tools{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px}
  .tool{min-width:84px;display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:12px;cursor:pointer;user-select:none}
  .tool.active{outline:2px solid var(--accent);background:rgba(72,209,255,0.12)}
  .dot{width:16px;height:16px;border-radius:50%}
  .toggles{display:flex;gap:8px}
  .toggle{background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);display:flex;gap:6px;align-items:center}
  .toggle input{appearance:none;width:28px;height:16px;background:#778;border-radius:999px;position:relative;outline:none}
  .toggle input:checked{background:#63e}
  .toggle input::after{content:"";position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:#fff;transition:left .15s}
  .toggle input:checked::after{left:14px}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;background:rgba(0,0,0,0.45)}
  .modal.show{display:flex}
  .modal .box{max-width:520px;width:100%;background:linear-gradient(180deg,var(--card),transparent);border:1px solid rgba(255,255,255,0.14);border-radius:18px;padding:16px}
  .rowSplit{display:flex;justify-content:space-between;align-items:center}
  .msg{margin:6px 0 14px 0;color:var(--muted)}
  .stars{font-size:20px;letter-spacing:2px}
  .footerRow{display:flex;gap:8px;justify-content:flex-end}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="stat">
      <div class="pill">Score: <span id="score">0</span></div>
      <div class="pill">Best: <span id="best">0</span></div>
      <div class="pill">Level <span id="orderNum">1</span></div>
    </div>
    <div class="stat">
      <button class="btn secondary" id="clearBtn">Clear</button>
      <button class="btn warn" id="bakeBtn">Bake</button>
    </div>
  </header>

  <div class="stage">
    <div class="canvasWrap">
      <canvas id="pizza"></canvas>
      <div class="hint" id="hint">Pick a topping, tap to place. Drag to move. Doubleâ€‘tap to delete.</div>
      <div class="selectBar" id="selectBar">
        <button class="sbtn" id="rotL">âŸ²</button>
        <button class="sbtn" id="rotR">âŸ³</button>
        <button class="sbtn" id="sizeMinus">âˆ’</button>
        <button class="sbtn" id="sizePlus">+</button>
        <button class="sbtn" id="del">Delete</button>
      </div>
    </div>
  </div>

  <!-- Bottom toolbar: goals + tools + toggles -->
  <div class="toolbar">
    <div class="reqRow">
      <div class="goals" id="goals"></div>
      <div class="toggles">
        <label class="toggle"><input type="checkbox" id="sauceToggle" checked><span>Sauce</span></label>
        <label class="toggle"><input type="checkbox" id="cheeseToggle" checked><span>Cheese</span></label>
      </div>
    </div>
    <div class="tools" id="toolGrid"></div>
  </div>

  <!-- Result Modal -->
  <div class="modal" id="modal">
    <div class="box">
      <div class="rowSplit">
        <h2 id="resultTitle">Order Result</h2>
        <div class="stars" id="stars">â˜… â˜… â˜…</div>
      </div>
      <div class="msg" id="resultMsg">Nice bake!</div>
      <ul id="breakdown" style="list-style:none;padding:0;margin:0 0 14px 0"></ul>
      <div class="rowSplit">
        <div class="muted">This level: <b id="delta">+0</b> points</div>
        <div class="muted">Total: <b id="totalAfter">0</b></div>
      </div>
      <div class="footerRow" style="margin-top:12px">
        <button class="btn secondary" id="keepImproving">Keep Editing</button>
        <button class="btn" id="nextOrder">Next Level</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ----- Data -----
  const TOPPINGS = [
    {key:'pepperoni',  label:'Pepperoni', color:'#d7423d', dot:'#bf2e29', target:10, r:18},
    {key:'mushroom',   label:'Mushroom',  color:'#e6d7b3', dot:'#cbb593', target:8,  r:18},
    {key:'olive',      label:'Olive',     color:'#1e1f25', dot:'#3a3d47', target:12, r:10},
    {key:'green_pepper',label:'Green Pepper', color:'#33c26b', dot:'#2aa85a', target:8, r:18},
    {key:'onion',      label:'Onion',     color:'#c28cff', dot:'#9b6cd9', target:8,  r:14},
    {key:'pineapple',  label:'Pineapple', color:'#ffd766', dot:'#e0b84d', target:8,  r:16},
    {key:'bacon',      label:'Bacon',     color:'#a33838', dot:'#7f2a2a', target:10, r:18},
    {key:'basil',      label:'Basil',     color:'#3bd67f', dot:'#2fb56b', target:8,  r:18},
  ];
  const keyToMeta = Object.fromEntries(TOPPINGS.map(t=>[t.key,t]));

  // Game config
  const REQUIRED_PER_LEVEL = 3; // number of distinct toppings required each level
  const FIRST_LEVEL_NEED_SCALE = 0.6; // % of target count needed to pass on level 1

  // ----- State -----
  let level = 1;
  let score = 0;
  let best = +localStorage.getItem('pizza_best_mobile') || 0;
  let currentGoals = [];// [{type, need}]
  let sauceOn = true, cheeseOn = true;

  const toppingsPlaced = []; // {id, type, x, y, rot, scale}
  let placingType = null;
  let selectedId = null;
  let draggingId = null;
  let lastTap = {t:0, x:0, y:0};

  // ----- DOM refs -----
  const canvas = document.getElementById('pizza');
  const ctx = canvas.getContext('2d');
  const toolGrid = document.getElementById('toolGrid');
  const goalsEl = document.getElementById('goals');
  const sauceToggle = document.getElementById('sauceToggle');
  const cheeseToggle = document.getElementById('cheeseToggle');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const orderNumEl = document.getElementById('orderNum');
  const bakeBtn = document.getElementById('bakeBtn');
  const clearBtn = document.getElementById('clearBtn');
  const hint = document.getElementById('hint');
  const selectBar = document.getElementById('selectBar');
  const rotL = document.getElementById('rotL');
  const rotR = document.getElementById('rotR');
  const sizeMinus = document.getElementById('sizeMinus');
  const sizePlus = document.getElementById('sizePlus');
  const delBtn = document.getElementById('del');

  // Modal
  const modal = document.getElementById('modal');
  const resultTitle = document.getElementById('resultTitle');
  const starsEl = document.getElementById('stars');
  const resultMsg = document.getElementById('resultMsg');
  const breakdown = document.getElementById('breakdown');
  const deltaEl = document.getElementById('delta');
  const totalAfter = document.getElementById('totalAfter');
  const keepImproving = document.getElementById('keepImproving');
  const nextOrder = document.getElementById('nextOrder');

  bestEl.textContent = best;

  // ----- Canvas sizing to fit screen exactly -----
  function fitCanvas(){
    const wrap = canvas.parentElement; // .canvasWrap
    // width is limited by CSS (100%), height by aspect-ratio 1/1
    const rect = wrap.getBoundingClientRect();
    const size = Math.floor(Math.min(rect.width, rect.height || rect.width));
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(size * dpr);
    canvas.height = Math.floor(size * dpr);
    draw();
  }
  const ro = new ResizeObserver(fitCanvas); ro.observe(document.body);

  // ----- Tools UI -----
  function buildTools(){
    toolGrid.innerHTML = '';
    TOPPINGS.forEach(t=>{
      const btn = document.createElement('div');
      btn.className = 'tool';
      btn.dataset.key = t.key;
      btn.innerHTML = `<div class="dot" style="background:${t.color}"></div><div>${t.label}</div>`;
      btn.addEventListener('pointerdown', e=>{ e.preventDefault(); setPlacing(t.key); });
      toolGrid.appendChild(btn);
    });
    updateToolActive();
  }
  function setPlacing(key){ placingType = key; selectedId=null; updateToolActive(); updateSelectBar(); hint.textContent='Tap pizza to place. Drag to move.'; }
  function updateToolActive(){ Array.from(toolGrid.children).forEach(el=> el.classList.toggle('active', el.dataset.key===placingType)); }

  // ----- Goals ("things you have to put") and Leveling -----
  function newLevel(){
    // reset pizza, keep score/best
    toppingsPlaced.length = 0; selectedId = null; placingType = null; updateToolActive(); sauceOn = sauceToggle.checked = true; cheeseOn = cheeseToggle.checked = true;
    currentGoals = generateGoals();
    level += (level===1?0:1); // start at level 1
    orderNumEl.textContent = level;
    renderGoals();
    draw();
  }
  function generateGoals(){
    // Pick REQUIRED_PER_LEVEL distinct toppings with required counts scaling with level
    const keys = [...TOPPINGS.map(t=>t.key)];
    const pick = [];
    while(pick.length<REQUIRED_PER_LEVEL){ const k = keys.splice(Math.floor(Math.random()*keys.length),1)[0]; pick.push(k); }
    const scale = 0.5 + Math.min(1, (level-1)*0.12); // gradually increase toward 100% of meta.target
    return pick.map(k=>({type:k, need: Math.max(3, Math.round(keyToMeta[k].target*scale))}));
  }
  function renderGoals(){ goalsEl.innerHTML=''; currentGoals.forEach(g=>{ const meta = keyToMeta[g.type]; const chip = document.createElement('div'); chip.className='goal'; chip.textContent = `${meta.label}: ${g.need}`; goalsEl.appendChild(chip); }); }

  // ----- Drawing -----
  function draw(){
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2;
    const R = Math.min(W,H)*0.42;

    // table bg
    const grd = ctx.createRadialGradient(cx, cy, R*0.1, cx, cy, R*1.6); grd.addColorStop(0, '#2d1d10'); grd.addColorStop(1, '#1b120b'); ctx.fillStyle = grd; ctx.fillRect(0,0,W,H);

    // board shadow
    ctx.save(); ctx.translate(cx,cy); ctx.beginPath(); ctx.arc(0,0,R*1.08,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.filter='blur(12px)'; ctx.fill(); ctx.restore(); ctx.filter='none';

    // crust + base
    ctx.save(); ctx.translate(cx,cy); circle(0,0,R, '#e5b05f'); circle(0,0,R*0.92, '#f4dca1'); if(sauceOn){ circle(0,0,R*0.86, '#c23a2b'); speckle(0,0,R*0.86, '#aa3225', 120, 1.1); } if(cheeseOn){ cheese(0,0,R*0.84); } ctx.restore();

    // toppings
    toppingsPlaced.forEach(t=> drawTopping(t, cx, cy, R));

    // selection ring
    if(selectedId!=null){ const t = toppingsPlaced.find(x=>x.id===selectedId); if(t){ ctx.save(); ctx.translate(cx,cy); const p = toPx(t.x,t.y,R); ctx.translate(p.x,p.y); ctx.lineWidth=2*dpr; ctx.strokeStyle='rgba(72,209,255,0.9)'; ctx.beginPath(); ctx.arc(0,0, keyToMeta[t.type].r * t.scale * dpr * 1.15, 0, Math.PI*2); ctx.stroke(); ctx.restore(); } }
  }

  function circle(x,y,r,color){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=color; ctx.fill(); }
  function speckle(x,y,r,color, n, s=1){ for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2; const rr=Math.sqrt(Math.random())*r*0.98; const px=x+Math.cos(a)*rr; const py=y+Math.sin(a)*rr; ctx.globalAlpha=0.25; circle(px,py, Math.random()*s+0.5, color); ctx.globalAlpha=1; } }
  function cheese(x,y,r){ circle(x,y,r,'#ffe7a1'); const n=100; for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2; const rr=Math.sqrt(Math.random())*r*0.96; const px=x+Math.cos(a)*rr; const py=y+Math.sin(a)*rr; ctx.globalAlpha=0.3; circle(px,py, Math.random()*2+0.8, '#f6d98c'); ctx.globalAlpha=1; } }

  function drawTopping(t, cx, cy, R){ const meta=keyToMeta[t.type]; const {x,y}=toPx(t.x,t.y,R); const dpr=window.devicePixelRatio||1; const rr=meta.r*t.scale*dpr; ctx.save(); ctx.translate(cx+x, cy+y); ctx.rotate(t.rot); switch(t.type){ case 'pepperoni': circle(0,0, rr, meta.color); speckle(0,0, rr*0.9, meta.dot, 10, 1.2); break; case 'mushroom': ctx.fillStyle=meta.color; ctx.beginPath(); ctx.arc(0,-rr*0.25, rr, Math.PI*0.1, Math.PI*0.9); ctx.fill(); ctx.fillRect(-rr*0.2, -rr*0.1, rr*0.4, rr*0.9); break; case 'olive': circle(0,0, rr, meta.color); circle(0,0, rr*0.5, '#f4dca1'); circle(0,0, rr*0.42, '#c23a2b'); break; case 'green_pepper': ctx.strokeStyle=meta.color; ctx.lineWidth=rr*0.6; ctx.lineCap='round'; ctx.beginPath(); ctx.arc(0,0, rr*0.8, Math.PI*0.2, Math.PI*1.3); ctx.stroke(); break; case 'onion': ctx.strokeStyle=meta.color; ctx.lineWidth=rr*0.35; ctx.beginPath(); ctx.arc(0,0, rr*0.9, 0, Math.PI*2); ctx.stroke(); ctx.globalAlpha=0.8; ctx.beginPath(); ctx.arc(0,0, rr*0.55, 0, Math.PI*2); ctx.stroke(); ctx.globalAlpha=1; break; case 'pineapple': ctx.fillStyle=meta.color; ctx.beginPath(); ctx.moveTo(-rr*0.9, rr*0.9); ctx.lineTo(rr*0.9, rr*0.9); ctx.lineTo(0, -rr*0.9); ctx.closePath(); ctx.fill(); break; case 'bacon': ctx.fillStyle=meta.color; ctx.save(); ctx.transform(1,0.2,0,1,0,0); ctx.fillRect(-rr, -rr*0.35, rr*2, rr*0.7); ctx.restore(); ctx.globalAlpha=0.45; ctx.fillStyle='#d26a6a'; ctx.fillRect(-rr*0.8, -rr*0.12, rr*1.6, rr*0.24); ctx.globalAlpha=1; break; case 'basil': ctx.fillStyle=meta.color; ctx.beginPath(); ctx.ellipse(0,0, rr*1.1, rr*0.6, 0, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='#2a9f5b'; ctx.lineWidth=Math.max(1,(window.devicePixelRatio||1)); ctx.beginPath(); ctx.moveTo(0,-rr*0.6); ctx.lineTo(0, rr*0.6); ctx.stroke(); break; } ctx.restore(); }

  function toPx(nx, ny, R){ const rad=R*0.84; return {x: nx*rad, y: ny*rad}; }
  function fromPx(px, py, R){ const rad=R*0.84; return {x: px/rad, y: py/rad}; }

  // ----- Interaction -----
  function addTopping(type, nx, ny){ const id=Date.now()+Math.random(); toppingsPlaced.push({id,type,x:nx,y:ny,rot:(Math.random()*Math.PI*2),scale:1}); selectedId=id; }

  function hitTest(nx, ny){ for(let i=toppingsPlaced.length-1; i>=0; i--){ const t=toppingsPlaced[i]; const dx=nx-t.x, dy=ny-t.y; const dist2=dx*dx+dy*dy; const rad=0.13; if(dist2 < rad*rad) return t.id; } return null; }

  function clampToPizza(nx, ny){ const r=Math.sqrt(nx*nx+ny*ny); if(r>1) return {x:nx/r, y:ny/r}; return {x:nx, y:ny}; }

  canvas.addEventListener('pointerdown', e=>{ e.preventDefault(); canvas.setPointerCapture(e.pointerId); const P=getNormPos(e); const id=hitTest(P.x,P.y); const now=performance.now(); if(selectedId && id===selectedId && (now-lastTap.t)<300 && dist2(P.x,P.y,lastTap.x,lastTap.y)<0.02){ const idx=toppingsPlaced.findIndex(t=>t.id===selectedId); if(idx>=0){ toppingsPlaced.splice(idx,1); selectedId=null; updateSelectBar(); draw(); return; } } lastTap={t:now,x:P.x,y:P.y}; if(id){ selectedId=id; draggingId=id; updateSelectBar(); draw(); return; } if(placingType){ addTopping(placingType,P.x,P.y); draggingId=selectedId; updateSelectBar(); draw(); } else { selectedId=null; updateSelectBar(); draw(); } });
  canvas.addEventListener('pointermove', e=>{ if(draggingId==null) return; e.preventDefault(); const P=getNormPos(e); const t=toppingsPlaced.find(x=>x.id===draggingId); if(!t) return; const c=clampToPizza(P.x,P.y); t.x=c.x; t.y=c.y; draw(); });
  canvas.addEventListener('pointerup', ()=>{ draggingId=null; });

  function getNormPos(e){ const rect=canvas.getBoundingClientRect(); const size=Math.min(rect.width, rect.height||rect.width); const offX=e.clientX-rect.left-size/2; const offY=e.clientY-rect.top-size/2; const Rpx=size*0.84/2; return {x: offX/Rpx, y: offY/Rpx}; }
  function dist2(x1,y1,x2,y2){ const dx=x1-x2, dy=y1-y2; return dx*dx+dy*dy; }

  // Selection bar
  rotL.onclick = ()=> tweakSel('rot', -Math.PI/12);
  rotR.onclick = ()=> tweakSel('rot', +Math.PI/12);
  sizeMinus.onclick = ()=> tweakSel('scale', -0.1, 0.5, 2.2);
  sizePlus.onclick  = ()=> tweakSel('scale', +0.1, 0.5, 2.2);
  delBtn.onclick    = ()=> { if(selectedId!=null){ const i=toppingsPlaced.findIndex(t=>t.id===selectedId); if(i>=0){toppingsPlaced.splice(i,1); selectedId=null; updateSelectBar(); draw();} } };

  function tweakSel(prop, delta, min=-Infinity, max=Infinity){ const t=toppingsPlaced.find(x=>x.id===selectedId); if(!t) return; if(prop==='rot'){ t.rot+=delta; } if(prop==='scale'){ t.scale=Math.max(min, Math.min(max, t.scale+delta)); } draw(); }
  function updateSelectBar(){ selectBar.classList.toggle('show', !!selectedId); }

  // Toggles + clear
  sauceToggle.addEventListener('change', ()=>{ sauceOn=sauceToggle.checked; draw(); });
  cheeseToggle.addEventListener('change', ()=>{ cheeseOn=cheeseToggle.checked; draw(); });
  clearBtn.onclick = ()=>{ toppingsPlaced.length=0; selectedId=null; updateSelectBar(); draw(); };

  // Bake + scoring with pass/fail to unlock next auto-generated level
  bakeBtn.onclick = ()=>{ const res=scoreLevel(); showResult(res); };

  function countPlaced(){ const m={}; for(const t of toppingsPlaced){ m[t.type]=(m[t.type]||0)+1; } return m; }

  function scoreLevel(){
    const counts = countPlaced();
    let delta = 0; const lines=[];

    const goalScale = (level===1? FIRST_LEVEL_NEED_SCALE : 1);
    let passed = true;

    for(const g of currentGoals){
      const hv = counts[g.type]||0;
      const need = Math.round(g.need*goalScale);
      const got = Math.min(hv, need);
      const miss = Math.max(0, need - hv);
      const pts = got*5 - miss*6;
      delta += pts;
      lines.push(`${keyToMeta[g.type].label}: need ${need}, placed ${hv} â†’ ${pts>=0?'+':''}${pts}`);
      if(miss>0) passed = false;
    }

    // extras penalty (unrequired toppings): first 2 free
    for(const k of Object.keys(counts)){
      if(!currentGoals.some(g=>g.type===k)){
        const extra = counts[k];
        const penalty = -Math.max(0, extra-2)*3;
        if(penalty!==0){ delta += penalty; lines.push(`${keyToMeta[k].label}: extra ${extra} â†’ ${penalty}`); }
      }
    }

    if(sauceOn) delta += 5; if(cheeseOn) delta += 5;

    const maxPossible = currentGoals.reduce((a,g)=>a+Math.round(g.need*goalScale)*5,0)+10;
    const ratio = Math.max(0, Math.min(1, delta / Math.max(1,maxPossible)));
    let stars = 1; if(ratio>0.6) stars=2; if(ratio>0.9) stars=3;
    let msg = passed? 'Level cleared! ðŸ•' : 'Missing required toppings.';

    score += Math.max(0, Math.round(delta));
    if(score>best){ best=score; localStorage.setItem('pizza_best_mobile', String(best)); }

    return { delta: Math.round(delta), lines, stars, msg, total: score, passed };
  }

  function showResult({delta, lines, stars, msg, total, passed}){
    breakdown.innerHTML = '';
    lines.forEach(s=>{ const li=document.createElement('li'); li.textContent=s; breakdown.appendChild(li); });
    resultMsg.textContent = msg;
    deltaEl.textContent = (delta>=0?'+':'')+delta;
    totalAfter.textContent = total;
    scoreEl.textContent = score;
    bestEl.textContent = best;
    starsEl.textContent = Array.from({length:3}, (_,i)=> i<stars ? 'â˜…' : 'â˜†').join(' ');
    resultTitle.textContent = passed ? 'Order Complete' : 'Try Again';
    modal.classList.add('show');
    ovenFlash();
  }
  keepImproving.onclick = ()=> modal.classList.remove('show');
  nextOrder.onclick = ()=>{ modal.classList.remove('show'); newLevel(); };

  function ovenFlash(){ const overlay=document.createElement('div'); overlay.style.position='absolute'; overlay.style.inset='0'; overlay.style.background='radial-gradient(120% 120% at 50% 50%, rgba(255,235,180,0.65), transparent 60%)'; overlay.style.pointerEvents='none'; overlay.style.animation='flash 600ms ease-out'; overlay.style.borderRadius='var(--radius)'; canvas.parentElement.appendChild(overlay); overlay.addEventListener('animationend', ()=> overlay.remove()); const style=document.createElement('style'); style.textContent='@keyframes flash { from { opacity:0 } 20% { opacity:1 } to { opacity:0 } }'; document.head.appendChild(style); }

  // ----- Init -----
  buildTools();
  fitCanvas();
  currentGoals = generateGoals();
  renderGoals();
  orderNumEl.textContent = level;
  toolGrid.addEventListener('pointerdown', ()=> hint.textContent='Tap pizza to place. Drag to move.');

})();
</script>
</body>
